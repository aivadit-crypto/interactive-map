// ========== TELEGRAM –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
let tg = window.Telegram?.WebApp;
if (tg) {
    tg.ready();
    tg.expand();
    tg.setBackgroundColor('#0a0a1a');
}

// ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let currentScale = 0.7;
let highlights = [];
let activeHighlight = null;
let isDragging = false;
let startX, startY;
let scrollLeft, scrollTop;

// –î–∞–Ω–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
const LOCATIONS = [
    { name: "–ñ–ö: –ó–µ–ª–µ–Ω–∞—è –ó–æ–Ω–∞", href: "https://t.me/c/3470681785/2156" },
    { name: "–ñ–ö: –°–∫–ª–∞–¥", href: "https://t.me/c/3470681785/2158" },
    { name: "–ñ–ö: –î–æ–º–∞", href: "https://t.me/c/3470681785/2164" },
    { name: "–ñ–ö: –ì–æ—Å—Ç–∏–Ω–∏—Ü–∞", href: "https://t.me/c/3470681785/2166" },
    { name: "–ñ–ö: –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è", href: "https://t.me/c/3470681785/2168" },
    { name: "–ì–ª–∞–≤–Ω–∞—è –ü–ª–æ—â–∞–¥—å", href: "https://t.me/c/3470681785/2170" },
    { name: "–í–ö: –Æ–∂–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞", href: "https://t.me/c/3470681785/2151" },
    { name: "–í–ö: –ó–∞–ø–∞–¥–Ω—ã–π –ø—É–Ω–∫—Ç", href: "https://t.me/c/3470681785/84" },
    { name: "–í–ö: –†—É–∏–Ω—ã", href: "https://t.me/c/3470681785/2153" },
    { name: "–í–ö: –í–æ—Å—Ç–æ—á–Ω—ã–π –ø—É–Ω–∫—Ç", href: "https://t.me/c/3470681785/2149" },
    { name: "–¢—å–º–∞: –°–µ–∫—Ç–æ—Ä 1", href: "https://t.me/c/3470681785/18" },
    { name: "–¢–∞–≤–µ—Ä–Ω–∞", href: "https://t.me/c/3470681785/2173" }
];

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
    createHighlights();
    createLocationButtons();
    setupAreaInteractivity();
    setupDragAndDrop(); // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    centerMap();
    
    // –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞
    if (isMobile()) {
        document.getElementById('controlPanel').style.display = 'grid';
    }
    
    console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞!');
});

// ========== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–û–ë–ò–õ–¨–ù–û–ì–û –£–°–¢–†–û–ô–°–¢–í–ê ==========
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// ========== –ù–ê–°–¢–†–û–ô–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø ==========
function setupDragAndDrop() {
    const container = document.getElementById('mapContainer');
    const wrapper = document.getElementById('mapWrapper');
    
    // –¢–æ–ª—å–∫–æ –¥–ª—è –ü–ö (–Ω–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
    if (isMobile()) return;
    
    // –°–æ–±—ã—Ç–∏—è –º—ã—à–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
    container.addEventListener('mousedown', startDragging);
    container.addEventListener('mousemove', drag);
    container.addEventListener('mouseup', stopDragging);
    container.addEventListener('mouseleave', stopDragging);
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    container.addEventListener('dragstart', (e) => e.preventDefault());
    
    function startDragging(e) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ area
        if (e.target.tagName === 'AREA' || e.target.tagName === 'IMG') {
            return; // –ü–æ–∑–≤–æ–ª—è–µ–º –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ area
        }
        
        isDragging = true;
        container.style.cursor = 'grabbing';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        startX = e.pageX - container.offsetLeft;
        startY = e.pageY - container.offsetTop;
        scrollLeft = container.scrollLeft;
        scrollTop = container.scrollTop;
        
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const x = e.pageX - container.offsetLeft;
        const y = e.pageY - container.offsetTop;
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const walkX = (x - startX) * 1.5; // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
        const walkY = (y - startY) * 1.5;
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.scrollLeft = scrollLeft - walkX;
        container.scrollTop = scrollTop - walkY;
    }
    
    function stopDragging() {
        isDragging = false;
        container.style.cursor = 'grab';
    }
}

// ========== –°–û–ó–î–ê–ù–ò–ï –ü–û–î–°–í–ï–¢–ö–ò ==========
function createHighlights() {
    const areas = document.querySelectorAll('area');
    const layer = document.getElementById('highlightLayer');
    
    console.log('–°–æ–∑–¥–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è', areas.length, '–æ–±–ª–∞—Å—Ç–µ–π');
    
    areas.forEach((area, index) => {
        const coords = area.getAttribute('coords');
        const shape = area.getAttribute('shape');
        
        if (!coords || !shape) return;
        
        const coordArray = coords.split(',').map(Number);
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        const highlight = document.createElement('div');
        highlight.className = 'area-highlight';
        highlight.dataset.index = index;
        
        if (shape === 'poly') {
            const xs = coordArray.filter((_, i) => i % 2 === 0);
            const ys = coordArray.filter((_, i) => i % 2 !== 0);
            
            const minX = Math.min(...xs);
            const minY = Math.min(...ys);
            const maxX = Math.max(...xs);
            const maxY = Math.max(...ys);
            
            highlight.style.left = minX + 'px';
            highlight.style.top = minY + 'px';
            highlight.style.width = (maxX - minX) + 'px';
            highlight.style.height = (maxY - minY) + 'px';
            
            // Clip path –¥–ª—è —Ç–æ—á–Ω–æ–π —Ñ–æ—Ä–º—ã
            let clipPath = 'polygon(';
            for (let i = 0; i < coordArray.length; i += 2) {
                clipPath += (coordArray[i] - minX) + 'px ' + (coordArray[i + 1] - minY) + 'px';
                if (i < coordArray.length - 2) clipPath += ', ';
            }
            clipPath += ')';
            highlight.style.clipPath = clipPath;
        }
        
        layer.appendChild(highlight);
        highlights[index] = highlight;
    });
}

// ========== –ù–ê–°–¢–†–û–ô–ö–ê –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–°–¢–ò –û–ë–õ–ê–°–¢–ï–ô ==========
function setupAreaInteractivity() {
    const areas = document.querySelectorAll('area');
    console.log('–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è', areas.length, '–æ–±–ª–∞—Å—Ç–µ–π');
    
    areas.forEach((area, index) => {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –æ–±–ª–∞—Å—Ç–∏ –µ—Å—Ç—å index
        if (!area.dataset.index) {
            area.dataset.index = index;
        }
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏
        area.addEventListener('mouseenter', function(e) {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            if (isDragging) return;
            
            const idx = this.dataset.index;
            const title = this.getAttribute('title') || this.getAttribute('alt');
            showHighlight(idx, title);
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        });
        
        area.addEventListener('mouseleave', function() {
            const idx = this.dataset.index;
            hideHighlight(idx);
        });
        
        // –ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏
        area.addEventListener('click', function(e) {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º - –æ—Ç–º–µ–Ω—è–µ–º –∫–ª–∏–∫
            if (isDragging) {
                e.preventDefault();
                return;
            }
            
            e.preventDefault();
            const idx = this.dataset.index;
            const href = this.getAttribute('href');
            const title = this.getAttribute('title') || this.getAttribute('alt');
            
            console.log('–ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏:', idx, title);
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
            flashHighlight(idx);
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            if (href) {
                setTimeout(() => {
                    window.open(href, '_blank');
                    showTooltip(`–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${title}`, 1500);
                }, 100);
            }
        });
        
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–∞—Å–∞–Ω–∏—è)
        area.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const idx = this.dataset.index;
            const title = this.getAttribute('title') || this.getAttribute('alt');
            showHighlight(idx, title);
        });
        
        area.addEventListener('touchend', function(e) {
            e.preventDefault();
            const idx = this.dataset.index;
            const href = this.getAttribute('href');
            const title = this.getAttribute('title') || this.getAttribute('alt');
            
            hideHighlight(idx);
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            if (href) {
                window.open(href, '_blank');
                showTooltip(`–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${title}`, 1500);
            }
        });
    });
}

// ========== –°–û–ó–î–ê–ù–ò–ï –ö–ù–û–ü–û–ö –õ–û–ö–ê–¶–ò–ô ==========
function createLocationButtons() {
    const container = document.getElementById('locationsList');
    
    LOCATIONS.forEach((loc, index) => {
        const btn = document.createElement('button');
        btn.className = 'location-btn';
        btn.textContent = loc.name;
        btn.title = `–ü–µ—Ä–µ–π—Ç–∏ –≤: ${loc.name}`;
        btn.dataset.index = index;
        
        btn.addEventListener('click', () => {
            window.open(loc.href, '_blank');
            showTooltip(`–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${loc.name}`, 1500);
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ–±–ª–∞—Å—Ç–∏
            const areas = document.querySelectorAll('area');
            areas.forEach((area, i) => {
                const alt = area.getAttribute('alt');
                if (alt === loc.name) {
                    flashHighlight(i);
                }
            });
        });
        
        container.appendChild(btn);
    });
}

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ê–°–®–¢–ê–ë–û–ú ==========
function zoomIn() {
    if (currentScale < 2.0) {
        currentScale += 0.1;
        updateZoom();
    }
}

function zoomOut() {
    if (currentScale > 0.3) {
        currentScale -= 0.1;
        updateZoom();
    }
}

function resetZoom() {
    currentScale = 0.7;
    updateZoom();
    centerMap();
}

function updateZoom() {
    const wrapper = document.getElementById('mapWrapper');
    
    if (isMobile()) {
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –æ–±—ã—á–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        wrapper.style.transform = `scale(${currentScale})`;
        wrapper.style.transformOrigin = 'top left';
    } else {
        // –î–ª—è –ü–ö - —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        wrapper.style.transform = `translate(-50%, -50%) scale(${currentScale})`;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    localStorage.setItem('map_scale', currentScale);
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

// ========== –§–£–ù–ö–¶–ò–ò –ü–û–î–°–í–ï–¢–ö–ò ==========
function showHighlight(index, title) {
    if (activeHighlight !== null) {
        hideHighlight(activeHighlight);
    }
    
    const highlight = highlights[index];
    if (highlight) {
        highlight.classList.add('active');
        activeHighlight = index;
        showTooltip(title);
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        const rect = highlight.getBoundingClientRect();
        const tooltip = document.getElementById('tooltip');
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.top - 10) + 'px';
        tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
    }
}

function hideHighlight(index) {
    const highlight = highlights[index];
    if (highlight) {
        highlight.classList.remove('active');
    }
    
    if (index === activeHighlight) {
        activeHighlight = null;
    }
    
    hideTooltip();
}

function flashHighlight(index) {
    const highlight = highlights[index];
    if (highlight) {
        highlight.style.backgroundColor = 'rgba(0, 255, 150, 0.5)';
        setTimeout(() => {
            highlight.style.backgroundColor = '';
        }, 300);
    }
}

// ========== –ü–û–î–°–ö–ê–ó–ö–ò ==========
function showTooltip(text, duration = 2000) {
    const tooltip = document.getElementById('tooltip');
    tooltip.textContent = text;
    tooltip.style.opacity = '1';
    
    if (duration > 0) {
        setTimeout(hideTooltip, duration);
    }
}

function hideTooltip() {
    document.getElementById('tooltip').style.opacity = '0';
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function centerMap() {
    const container = document.getElementById('mapContainer');
    const wrapper = document.getElementById('mapWrapper');
    
    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    if (isMobile()) {
        container.scrollLeft = (wrapper.offsetWidth * currentScale - container.clientWidth) / 2;
        container.scrollTop = (wrapper.offsetHeight * currentScale - container.clientHeight) / 2;
    }
    // –î–ª—è –ü–ö - —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ transform
    else {
        // –£–∂–µ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ CSS
    }
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function closeApp() {
    if (tg) {
        tg.close();
    } else {
        alert('–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Telegram');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
const savedScale = localStorage.getItem('map_scale');
if (savedScale) {
    currentScale = parseFloat(savedScale);
    setTimeout(updateZoom, 100);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏
document.addEventListener('mousemove', (e) => {
    const tooltip = document.getElementById('tooltip');
    if (tooltip.style.opacity === '1') {
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY - 40) + 'px';
        tooltip.style.transform = 'none';
    }
});
